# è´¨é‡æ£€æŸ¥å·¥ä½œæµ / Quality Check Workflow
# å¯¹æ‰€æœ‰Pull Requestæ‰§è¡Œè‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥

name: Quality Assurance / è´¨é‡ä¿è¯

on:
  pull_request:
    paths:
      - 'skills/**'
      - '.github/workflows/quality-check.yml'
  workflow_dispatch:

jobs:
  detect-changes:
    name: æ£€æµ‹å˜æ›´ / Detect Changes
    runs-on: ubuntu-latest
    outputs:
      skills: ${{ steps.changes.outputs.skills }}
    steps:
      - name: Checkout / æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed skills / æ£€æµ‹å˜æ›´çš„skills
        id: changes
        run: |
          # èŽ·å–å˜æ›´çš„skillç›®å½•
          CHANGED_SKILLS=$(git diff --name-only origin/main...HEAD | grep "^skills/" | cut -d'/' -f2 | sort -u | jq -R . | jq -s . | tr -d '\n' | tr -d ' ')
          echo "skills=$CHANGED_SKILLS" >> $GITHUB_OUTPUT
          echo "Changed skills: $CHANGED_SKILLS"

  quality-check:
    name: è´¨é‡æ£€æŸ¥ / Quality Check
    needs: detect-changes
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.skills != '[]' }}
    strategy:
      matrix:
        skill: ${{ fromJson(needs.detect-changes.outputs.skills) }}
    steps:
      - name: Checkout / æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Setup Python / è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run quality check / æ‰§è¡Œè´¨é‡æ£€æŸ¥
        run: |
          echo "ðŸ” Checking skill: ${{ matrix.skill }}"
          python tools/quality-check/quality-check.py "skills/${{ matrix.skill }}"

      - name: Upload report / ä¸Šä¼ æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: quality-report-${{ matrix.skill }}
          path: skills/${{ matrix.skill }}/quality-report.json

  security-scan:
    name: å®‰å…¨æ‰«æ / Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout / æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Setup Python / è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools / å®‰è£…å®‰å…¨å·¥å…·
        run: |
          pip install bandit safety pip-audit

      - name: Run Bandit / æ‰§è¡ŒBanditæ‰«æ
        run: |
          echo "ðŸ”’ Running Bandit security scan..."
          bandit -r skills/ -f json -o bandit-report.json || true
          bandit -r skills/ || true

      - name: Check dependencies / æ£€æŸ¥ä¾èµ–å®‰å…¨
        run: |
          echo "ðŸ“¦ Checking dependency vulnerabilities..."
          find skills -name "requirements.txt" -exec pip-audit -r {} \; || true

      - name: Upload security report / ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-report
          path: bandit-report.json
        if: always()

  lint-check:
    name: ä»£ç é£Žæ ¼æ£€æŸ¥ / Lint Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout / æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Setup Python / è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install lint tools / å®‰è£…æ£€æŸ¥å·¥å…·
        run: |
          pip install flake8 pylint black

      - name: Run flake8 / æ‰§è¡Œflake8
        run: |
          echo "ðŸ“‹ Running flake8..."
          flake8 skills/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 skills/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true

      - name: Run pylint / æ‰§è¡Œpylint
        run: |
          echo "ðŸ“‹ Running pylint..."
          find skills -name "*.py" -path "*/scripts/*" -exec pylint {} \; || true

      - name: Check black formatting / æ£€æŸ¥blackæ ¼å¼
        run: |
          echo "ðŸ“‹ Checking black formatting..."
          black --check skills/ || true

  summary:
    name: è´¨é‡æ€»ç»“ / Quality Summary
    needs: [quality-check, security-scan, lint-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout / æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Download all reports / ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Generate summary / ç”Ÿæˆæ€»ç»“
        run: |
          echo "# ðŸ† è´¨é‡æ£€æŸ¥æŠ¥å‘Š / Quality Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š æ£€æŸ¥ç»“æžœ / Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ / Check Item | çŠ¶æ€ / Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------------|---------------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.quality-check.result }}" == "success" ]; then
            echo "| è´¨é‡è¯„åˆ† / Quality Score | âœ… é€šè¿‡ / Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| è´¨é‡è¯„åˆ† / Quality Score | âŒ éœ€æ”¹è¿› / Needs Improvement |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "| å®‰å…¨æ‰«æ / Security Scan | âœ… é€šè¿‡ / Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| å®‰å…¨æ‰«æ / Security Scan | âš ï¸ éœ€æ£€æŸ¥ / Needs Review |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.lint-check.result }}" == "success" ]; then
            echo "| ä»£ç é£Žæ ¼ / Code Style | âœ… é€šè¿‡ / Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ä»£ç é£Žæ ¼ / Code Style | âš ï¸ éœ€ä¼˜åŒ– / Needs Optimization |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ è¯¦ç»†æŠ¥å‘Š / Detailed Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹Artifactsä¸­çš„æŠ¥å‘Šæ–‡ä»¶ã€‚/ Please check report files in Artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“– è´¨é‡æ ‡å‡† / Quality Standards" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯¦ç»†æ ‡å‡†è¯·å‚è€ƒ / Detailed standards: [QUALITY_STANDARDS.md](../../docs/quality-assurance/QUALITY_STANDARDS.md)" >> $GITHUB_STEP_SUMMARY
