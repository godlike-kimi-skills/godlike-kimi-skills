# æ¯æ—¥ç«žå“æ‰«æ / Daily Competitor Scan
# è‡ªåŠ¨ç›‘æŽ§ç«žå¯¹æ–°å¢žskills

name: Daily Competitor Scan / æ¯æ—¥ç«žå“æ‰«æ

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹æ‰§è¡Œ (UTC 1:00)
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  scan:
    name: Scan Competitors / æ‰«æç«žå¯¹
    runs-on: ubuntu-latest
    steps:
      - name: Checkout / æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Setup Python / è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies / å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: Run scanner / æ‰§è¡Œæ‰«æ
        run: |
          python tools/competitor-scanner/daily-scan.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for new opportunities / æ£€æŸ¥æ–°æœºä¼š
        id: check
        run: |
          if [ -f "docs/competitive-analysis/daily-reports/scan-report-$(date +%Y%m%d).json" ]; then
            NEW_OPPS=$(cat docs/competitive-analysis/daily-reports/scan-report-$(date +%Y%m%d).json | jq '.new_opportunities | length')
            echo "new_opportunities=$NEW_OPPS" >> $GITHUB_OUTPUT
            if [ "$NEW_OPPS" -gt 0 ]; then
              echo "has_new=true" >> $GITHUB_OUTPUT
            else
              echo "has_new=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload reports / ä¸Šä¼ æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: docs/competitive-analysis/daily-reports/

      - name: Create issue for new opportunities / ä¸ºæ–°æœºä¼šåˆ›å»ºIssue
        if: steps.check.outputs.has_new == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newOpps = '${{ steps.check.outputs.new_opportunities }}';
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ†• å‘çŽ° ${newOpps} ä¸ªæ–°Skillsæœºä¼š / New Skills Opportunities Found`,
              body: `æ¯æ—¥æ‰«æå‘çŽ° ${newOpps} ä¸ªæ–°çš„Skillsç§»æ¤æœºä¼šã€‚\n\nè¯·æŸ¥çœ‹æŠ¥å‘Šå¹¶å¿«é€Ÿç§»æ¤ã€‚\n\næŠ¥å‘Šä½ç½®: docs/competitive-analysis/daily-reports/`,
              labels: ['opportunity', 'automated']
            });

  notify:
    name: Notify Results / é€šçŸ¥ç»“æžœ
    needs: scan
    runs-on: ubuntu-latest
    steps:
      - name: Summary / æ€»ç»“
        run: |
          echo "# ðŸ” æ¯æ—¥ç«žå“æ‰«æå®Œæˆ / Daily Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ‰«ææ—¶é—´ / Scan time: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹Artifactsä¸­çš„å®Œæ•´æŠ¥å‘Šã€‚/ Please check full report in Artifacts." >> $GITHUB_STEP_SUMMARY
