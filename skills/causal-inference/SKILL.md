# Causal Inference

**理论基础**: Judea Pearl (因果推断)  
**核心著作**: 《为什么》(The Book of Why)  
**类型**: 系统与因果  
**优先级**: P0

---

## 核心问题

> **相关 ≠ 因果**

经典谬误:
- 冰淇淋销量 ↑ 与 溺水事故 ↑ 相关
- 但因果是: 高温 → 两者同时↑

**因果推断三层次** (Pearl):

| 层次 | 问题 | 能力 |
|------|------|------|
| **关联** | 观察到X，Y如何？ | P(Y\|X) |
| **干预** | 实施X，Y如何？ | P(Y\|do(X)) |
| **反事实** | 如果X没发生？ | P(Yₓ' \| X=x) |

---

## 因果模型框架

### 1. 因果图 (Causal DAG)

**基本结构**:

```
链式: X → Z → Y      (Z是中介)
分叉: X ← Z → Y      (Z是混淆变量)
对撞: X → Z ← Y      (Z是对撞点，控制Z会打开路径)
```

**案例: 在线教育效果分析**

```
原始错误模型:
在线学习时长 → 成绩提升

真实因果图:
               学生能力
                   ↓
    ┌──────────────┼──────────────┐
    ↓              ↓              ↓
学习动机 ←──── 在线时长 ────→ 成绩提升
    ↑                              ↑
    └────────── 作业完成 ──────────┘

分析:
├─ 混淆变量: 学生能力、学习动机
├─ 中介变量: 作业完成
└─ 直接效应: 在线时长 → 成绩提升
```

### 2. do-演算 (Do-Calculus)

**干预 vs 观察**:

```
观察: P(成绩|在线学习=多) 
      → 可能包含能力强的学生本来就爱学习

干预: P(成绩|do(在线学习=多))
      → 随机分配学生学习时长，消除选择偏差
```

**后门准则** (Back-door Criterion):

```
要估计 X → Y 的因果效应:
1. 找到所有指向X的路径 (后门路径)
2. 识别混淆变量集合Z，阻断所有后门路径
3. 控制Z后，关联即因果

公式: P(Y|do(X)) = Σz P(Y|X,Z)P(Z)
```

### 3. 反事实推理

```
问题: 如果Alice没参加培训，她的业绩会怎样？

反事实定义:
Y₀(A) = 如果A没参加培训的业绩
Y₁(A) = 如果A参加培训的业绩

因果效应: τ(A) = Y₁(A) - Y₀(A)

问题: 我们只能观察到Y₁(A)或Y₀(A)之一
解决: 通过相似个体估计
```

---

## 识别策略

### 1. 随机对照试验 (RCT) - 黄金标准

```
设计:
├─ 实验组: 随机分配，接受干预
└─ 对照组: 随机分配，不接受干预

关键: 随机化确保两组在各方面可比

分析: 简单均值差
ATE = E[Y|Treatment] - E[Y|Control]
```

### 2. 自然实验

```
断点回归 (RDD):
├─ 场景: 考试60分及格线，60分以上获得奖学金
├─ 思路: 比较59分和61分学生 (能力相近)
└─ 识别: 奖学金对成绩的影响

双重差分 (DiD):
├─ 场景: A城市实施政策，B城市未实施
├─ 思路: (A后-A前) - (B后-B前)
└─ 假设: 平行趋势 (无政策时趋势相同)

工具变量 (IV):
├─ 场景: 研究教育对收入的影响 (教育有自选择)
├─ 工具: 离最近大学距离 (影响教育但不直接影响收入)
└─ 思路: 通过工具变量隔离外生变化
```

### 3. 因果发现算法

```
PC算法:
1. 从完全连接图开始
2. 基于条件独立性检验，逐步删除边
3. 确定边的方向 (利用V结构)
4. 输出因果图骨架

GES算法:
- 基于评分函数搜索最优图结构
```

---

## Kbot应用框架

### 应用场景: 业务增长归因

```
问题: 用户增长是因为产品改进还是营销投放?

因果图构建:
                    季节因素
                       ↓
    ┌──────────────────┼──────────────────┐
    ↓                  ↓                  ↓
产品改进 ──→ 用户满意度 ──→ 留存率 ──→ 用户增长
    ↑                  ↑                  ↑
营销投放 ──→ 品牌认知 ─────┘                  │
    ↑                                         │
    └─────────────────────────────────────────┘

分析步骤:
1. 识别混淆变量: 季节因素
2. 数据收集: 同期群分析，控制季节
3. 效应分解:
   ├─ 产品改进直接效应: +15%
   ├─ 营销投放直接效应: +20%
   └─ 交互效应: +5%

结论: 两者都有贡献，但营销短期效应更大
```

### 应用场景: 策略效果评估

```
问题: 新定价策略真的提升了收入吗?

因果设计:
├─ 实验组: 新定价 (1000用户)
├─ 对照组: 旧定价 (1000用户)
└─ 随机分配确保可比性

分析结果:
├─ 观察: 实验组收入↑30%
├─ 因果: do(新定价) → 收入↑25%±5%
└─ 排除: 用户质量差异、时间趋势

反事实: 如果未实施新定价，收入将是X
```

---

## 因果推断检查清单

- [ ] 是否绘制了因果图？
- [ ] 是否识别了所有混淆变量？
- [ ] 是否应用了后门准则？
- [ ] 数据收集是否支持因果识别？
- [ ] 是否考虑了选择偏差？
- [ ] 是否进行了敏感性分析？
- [ ] 结论是否标注了置信区间？

---

## 常见陷阱

| 陷阱 | 案例 | 解决 |
|------|------|------|
| 混淆变量 | 能力强→高薪+长寿 | 控制能力变量 |
| 选择偏差 | 志愿者效应 | 随机化或工具变量 |
| 反向因果 | 警察→犯罪还是犯罪→警察？ | 时序分析+工具变量 |
| 过度控制 | 控制中介变量 | 只控制前置变量 |
| 样本选择 | 只分析存活企业 | Heckman修正 |

---

*相关告诉你"是什么"，因果告诉你"为什么"。*
