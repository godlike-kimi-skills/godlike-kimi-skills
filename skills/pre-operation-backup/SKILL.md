# Pre-Operation Backup

**敏感操作前自动备份** - Official Native Skill for Kimi CLI

在执行任何敏感、危险或不可逆操作前，自动创建系统快照，确保可以安全回滚。借鉴Veeam、Commvault、Zerto等企业级备份方案。

---

## 核心特性

### 🛡️ 自动保护机制

| 触发场景 | 自动操作 | 恢复方式 | RTO目标 |
|---------|---------|---------|---------|
| **修改系统配置** | 自动备份config.toml | 一键恢复 | < 30秒 |
| **删除skills** | 备份被删除的skill | 从备份还原 | < 1分钟 |
| **更新SKILL.md** | 创建修改前快照 | 版本回滚 | < 30秒 |
| **Git危险操作** | 自动stash + 标签 | 检查点恢复 | < 2分钟 |
| **批量文件操作** | 创建完整快照 | 选择性恢复 | < 5分钟 |
| **配置变更** | 差异备份 | 增量回滚 | < 1分钟 |

### 📸 快照类型

```
操作前自动快照层级:
├── 🟢 Light (轻量)    - 仅P0关键文件 (<1秒, 本地存储)
├── 🟡 Standard (标准) - 完整配置 + Memory (3-5秒, 本地+异地)
└── 🔴 Full (完整)    - 全系统备份 (10-30秒, 多副本)
```

### 🔐 备份安全特性

| 特性 | 说明 | 实现方式 |
|------|------|----------|
| **加密存储** | 备份数据加密 | AES-256-GCM |
| **完整性校验** | 防篡改验证 | SHA-256 + HMAC |
| **访问控制** | 备份访问限制 | RBAC + 多因素认证 |
| **安全删除** | 过期备份销毁 | DoD 5220.22-M标准 |
| **异地冗余** | 灾难恢复能力 | 多位置存储 |

---

## 使用方法

### 手动创建操作前备份
```bash
# 标准备份（推荐）
pre-operation-backup create

# 轻量备份（快速操作）
pre-operation-backup create --level light

# 完整备份（重大变更）
pre-operation-backup create --level full --reason "删除10个skills"

# 带加密的备份
pre-operation-backup create --level full --encrypt --password-protected
```

### 自动保护模式
```bash
# 启用自动保护（在执行危险操作前自动备份）
pre-operation-backup enable-auto

# 配置保护级别
pre-operation-backup config --level standard --encrypt-by-default true

# 配置保留策略
pre-operation-backup config --retention-light 24h --retention-standard 7d --retention-full 30d
```

### 恢复操作
```bash
# 列出所有操作前快照
pre-operation-backup list --show-size --show-integrity

# 恢复到最近的操作前状态
pre-operation-backup restore --verify-integrity

# 选择性恢复（仅恢复特定文件）
pre-operation-backup restore --file config.toml --target-path ./recovery/

# 恢复到指定时间点
pre-operation-backup restore --timestamp 2026-02-19T10:30:00Z

# 验证备份完整性（不恢复）
pre-operation-backup verify --backup-id pre-op-20260219-120530
```

---

## 危险操作自动检测

### 自动触发备份的操作

| 操作类型 | 检测关键词 | 自动备份级别 | 置信度 |
|---------|-----------|-------------|--------|
| **删除技能** | `remove skill`, `delete skill`, `rm -rf` | Standard | 高 |
| **修改配置** | `edit config`, `update config.toml` | Light | 高 |
| **批量修改** | `批量`, `batch`, `all skills` | Full | 高 |
| **Git危险操作** | `git reset`, `git clean`, `force push` | Standard | 高 |
| **文件系统操作** | `rm -rf`, `del /f`, `format` | Full | 中 |
| **权限修改** | `chmod 777`, `takeown`, `icacls` | Standard | 中 |
| **注册表操作** | `reg delete`, `regedit` | Light | 中 |

### 智能风险评估

```python
# 风险评分算法
def calculate_risk_score(operation):
    score = 0
    # 不可逆性权重
    if is_irreversible(operation): score += 40
    # 影响范围权重  
    if affects_multiple_files(operation): score += 30
    # 系统关键性权重
    if targets_system_files(operation): score += 20
    # 权限要求权重
    if requires_elevation(operation): score += 10
    return score

# 备份级别决策
if risk_score >= 70: level = "Full"
elif risk_score >= 40: level = "Standard"
else: level = "Light"
```

---

## 快照管理

### 快照命名规范
```
pre-op-{timestamp}-{level}-{reason}-{hash}

示例:
- pre-op-20260219-120530-light-config-change-a1b2c3
- pre-op-20260219-120545-standard-skill-delete-d4e5f6
- pre-op-20260219-120600-full-system-upgrade-7g8h9i
```

### 保留策略
```
Light快照:   保留24小时 (最多20个)   → 本地加密存储
Standard快照: 保留7天 (最多10个)    → 本地+云端加密
Full快照:    保留30天 (最多5个)     → 多副本异地
```

### 存储架构

```
┌─────────────────────────────────────────────────────────────┐
│                     备份存储架构                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Primary    │  │  Secondary   │  │   Archive    │      │
│  │   (Local)    │  │   (Cloud)    │  │   (Cold)     │      │
│  │              │  │              │  │              │      │
│  │ • 快速恢复   │  │ • 灾难恢复   │  │ • 合规归档   │      │
│  │ • AES加密    │  │ • 异地冗余   │  │ • WORM存储   │      │
│  │ • 7天保留    │  │ • 30天保留   │  │ • 7年保留    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
│  同步机制:                                                   │
│  Primary → Secondary: 实时加密同步                          │
│  Secondary → Archive: 每日批量归档                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 与其他技能协作

```
危险操作执行流程:

1. 用户请求: "删除 crypto-wallet skill"
          ↓
2. pre-operation-backup 检测危险操作
   └── 风险评分: 65/100 → Standard级别
          ↓
3. 自动创建 standard 级别快照
   ├── 备份skill文件
   ├── 备份相关配置
   ├── 生成完整性哈希
   └── 加密存储
          ↓
4. 执行删除操作
          ↓
5. 确认删除成功
   └── 标记快照为"保留"
          ↓
6. 保留快照7天（用于回滚）
   └── 到期自动安全删除
```

---

## 深度安全分析

### 1. Threat Modeling (威胁建模)

Pre-Operation Backup Skill保护用户数据，但其自身也成为攻击目标，需系统分析潜在威胁：

**备份数据窃取 (Backup Theft)**：攻击者可能窃取备份文件获取敏感配置、技能代码和用户数据。备份通常包含完整系统状态，是最有价值的目标。建议实施强加密，使用AES-256-GCM加密所有备份数据。密钥派生使用Argon2id，抵抗暴力破解。支持密码保护备份，恢复时需要额外认证。

**备份篡改 (Backup Tampering)**：攻击者可能修改备份内容，在恢复时植入恶意代码或配置。完整性校验失败可能被绕过。建议实施数字签名，每个备份使用HMAC-SHA256签名。存储哈希值到独立的安全日志。定期完整性验证，检测静默篡改。

**勒索软件攻击 (Ransomware)**：勒索软件可能加密备份文件，使恢复机制失效。攻击者可能专门定位备份目录。建议实施备份隔离，备份存储与主系统网络隔离。不可变备份选项，WORM存储防止修改。异地冗余，云端备份不受本地勒索软件影响。

**恢复过程攻击 (Recovery Attack)**：恢复操作本身可能被利用执行恶意代码，如恢复被篡改的备份。攻击者可能诱导用户恢复到恶意状态。建议实施恢复前验证，恢复前强制完整性检查。沙箱恢复测试，先恢复到隔离环境验证。增量恢复选项，选择性恢复最小必要数据。

**保留策略绕过 (Retention Bypass)**：攻击者可能利用保留策略漏洞，使恶意备份长期保留或提前删除合法备份。建议实施强制保留期，备份在保留期内不可删除。多副本策略，防止单点篡改。审计日志记录所有备份生命周期操作。

### 2. Defense in Depth (纵深防御)

备份系统作为最后防线，需要最强级别的纵深防御：

**数据采集层防御**：备份过程中数据在内存中加密处理，避免明文残留。使用安全临时文件，备份完成后立即覆盖。增量备份仅传输变化的数据块，减少暴露面。压缩和加密同时进行，避免中间明文文件。

**传输层防御**：本地备份使用专用加密通道，即使本地传输也加密。云端同步使用TLS 1.3 with Certificate Pinning。支持代理服务器，通过安全网关传输。传输中断自动重试，保证数据完整性。

**存储层防御**：本地备份存储于加密文件系统或加密容器。云端备份使用客户端加密，服务提供商无法解密。支持多云存储，避免供应商锁定和单点故障。冷存储归档使用硬件加密存储介质。

**访问控制层防御**：备份访问需多因素认证，支持TOTP和硬件密钥。基于角色的访问控制，区分备份创建者、恢复操作员、审计员。时间窗口限制，仅在特定时间段允许恢复操作。地理位置限制，检测异常位置的恢复请求。

**生命周期层防御**：自动过期清理，到期备份使用安全删除算法覆写。删除前确认机制，防止误删除。删除操作不可逆，防止恢复已删除备份。删除审计日志，记录谁、何时、为何删除备份。

### 3. Zero Trust (零信任)

零信任原则在备份场景中的关键应用：

**永不信任备份完整性**：假设备份可能被篡改或损坏，每次恢复前强制验证完整性。多哈希算法验证，SHA-256和BLAKE3双重校验。定期完整性扫描，主动检测备份损坏。自我修复机制，发现损坏时尝试从冗余副本修复。

**持续验证恢复环境**：恢复前验证目标环境安全性，检测恶意软件感染。设备信任验证，确保恢复目标符合安全基线。网络环境检查，防止在不安全网络恢复敏感数据。运行时监控，检测恢复过程中的异常行为。

**最小权限备份**：备份服务按功能拆分权限，收集、存储、恢复各自独立权限。备份服务账户仅拥有读取源文件和写入备份目录的权限。临时权限提升，需要时动态申请，使用后立即释放。权限使用监控，检测异常权限使用模式。

**微分段存储**：不同类型的备份存储在隔离的安全域。技能备份、配置备份、记忆备份物理隔离。生产备份和测试备份网络隔离。敏感备份和普通备份访问控制分离。

**假设备份已泄露设计**：设计假设备份文件可能被非法获取，最小化备份中的敏感信息。支持选择性备份，排除特定敏感文件。PII自动检测和脱敏，备份前处理敏感数据。密钥分离，备份加密密钥与备份数据分离存储。

### 4. Risk Assessment (风险评估)

备份系统风险评估需考虑其作为最后防线的关键性和被攻击的高价值：

**关键风险场景**：
- 灾难性风险：备份系统被攻陷，攻击者可访问所有历史备份 (概率: 低，影响: 灾难性) - 风险等级: 严重
- 严重风险：备份加密被破解，敏感数据泄露 (概率: 低，影响: 严重) - 风险等级: 高
- 高风险：备份完整性被破坏，恢复时引入恶意代码 (概率: 中，影响: 高) - 风险等级: 高
- 中风险：备份保留策略不当导致存储耗尽或合规违规 (概率: 中，影响: 中) - 风险等级: 中
- 中风险：恢复过程失败导致数据丢失 (概率: 低，影响: 中) - 风险等级: 中

**风险定量分析**：
- 数据丢失成本：根据数据价值评估，可能达数百万美元
- 恢复失败成本：业务中断平均 $5,600/分钟
- 合规罚款：数据保护违规最高 4% 全球营业额
- 备份系统价值：作为勒索软件防护的最后防线，价值等同于全部数据资产

**脆弱性评估**：
- 关键脆弱性：备份集中存储，单点被攻破影响所有历史备份
- 高危脆弱性：备份密码可能被社工或暴力破解
- 中危脆弱性：备份元数据可能泄露系统结构信息
- 低危脆弱性：备份文件名可能包含敏感信息

**风险处置策略**：
| 风险 | 处置策略 | 控制措施 | 优先级 |
|------|----------|----------|--------|
| 备份窃取 | 缓解 | 强加密+访问控制 | P0 |
| 完整性破坏 | 缓解 | 数字签名+完整性校验 | P0 |
| 勒索软件 | 缓解 | 不可变备份+异地冗余 | P0 |
| 恢复失败 | 缓解 | 定期恢复演练+验证 | P1 |

**关键风险指标(KRI)**：
- 备份完整性校验失败次数
- 未授权备份访问尝试
- 备份数据导出量异常
- 恢复失败率
- 备份存储容量趋势

### 5. Compliance Framework (合规框架)

备份管理需满足数据保护和业务连续性合规要求：

**数据保护合规**：
- GDPR Article 32：实施适当技术措施保护个人数据，包括备份能力
- GDPR Article 17 (删除权)：备份中的个人数据需在合理时间范围内删除
- CCPA：消费者有权了解其数据备份情况
- 中国网络安全法：重要数据备份是网络安全保护义务

**业务连续性合规**：
- ISO 22301：业务连续性管理体系，备份是核心控制措施
- NIST SP 800-34：IT系统应急计划指南
- 等保2.0：三级系统要求定期备份，异地备份

**行业特定合规**：
- PCI DSS 9.5 & 12.10.5：持卡人数据环境保护和备份要求
- HIPAA 164.308(a)(7)：数据备份计划是必备的安全措施
- SOX 404：财务数据备份和恢复是内部控制的一部分

**备份合规控制**：
- 保留策略合规：根据法规要求设置保留期限
- 加密合规：使用符合FIPS 140-2标准的加密算法
- 访问日志：记录所有备份访问用于审计
- 定期测试：恢复演练证明备份有效性

**审计与报告**：
- 备份状态报告：定期生成备份成功率和完整性报告
- 合规差距分析：识别备份策略与法规要求的差距
- 审计证据：备份日志作为控制有效性证据
- 事件响应支撑：备份在数据泄露事件中的恢复作用

---

## 最佳实践

1. **永远不要关闭自动保护** - 这是你的安全网
2. **重大操作前手动创建Full快照** - 给自己更多保障
3. **定期测试恢复流程** - 确保备份是可用的
4. **启用备份加密** - 防止备份数据泄露
5. **异地备份关键数据** - 防止单点故障
6. **定期清理旧快照** - 避免占用过多空间
7. **监控备份完整性** - 及时发现备份损坏

---

## 相关技能

- `memory-backup-scheduler` - 定时备份调度
- `git-automation` - Git备份集成
- `archive-extractor` - 备份文件解压
- `security-check` - 备份安全验证

---

## 版本信息

- **Version**: 1.1.0 (安全增强版)
- **Author**: KbotGenesis
- **Type**: Official Native
- **Priority**: Critical (建议所有项目启用)
- **Compliance**: GDPR, PCI DSS, HIPAA, 等保2.0
- **Last Security Review**: 2026-02-19
