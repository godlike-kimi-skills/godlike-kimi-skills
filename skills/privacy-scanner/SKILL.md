# Privacy Scanner

**生产级隐私安全扫描** - 借鉴 OSQuery, Wazuh, GDPR Scanner

检测隐私泄露风险、敏感数据暴露、合规违规，提供数据保护建议。

---

## 核心特性

### 🔍 扫描模块 (借鉴 OSQuery)

| 模块 | 检查项 | 风险等级 |
|------|--------|----------|
| **浏览器数据** | Cookie、历史、缓存、密码 | 高 |
| **系统日志** | 应用日志、事件查看器 | 中 |
| **临时文件** | Temp、Recent、Prefetch | 中 |
| **剪贴板** | 历史记录 | 低 |
| **缩略图** | 图片预览缓存 | 低 |
| **注册表** | 最近文档、MRU列表 | 中 |
| **内存转储** | 崩溃转储、休眠文件 | 高 |
| **回收站** | 已删除文件残留 | 中 |
| **缩略图缓存** | 图片预览数据库 | 低 |
| **网络凭证** | 保存的密码、证书 | 严重 |

### 📊 隐私评分

```
评分标准 (0-100):
├── 0-40:  高危 (大量隐私泄露风险)
├── 41-60: 中危 (存在明显隐私问题)
├── 61-80: 低危 (少量问题)
└── 81-100: 优秀 (隐私保护良好)
```

### 🛡️ 隐私风险等级

| 等级 | 描述 | 示例 |
|------|------|------|
| **严重** | 可导致直接身份盗用或财务损失 | 明文存储的银行密码、私钥文件 |
| **高危** | 可导致隐私泄露或追踪 | 未加密的身份信息、完整浏览历史 |
| **中危** | 可被利用进行社会工程学攻击 | 近期文档列表、应用使用记录 |
| **低危** | 轻微隐私暴露 | 临时文件、缩略图缓存 |

---

## 使用方法

### 快速扫描
```bash
# 完整隐私扫描
python ~/.kimi/skills/privacy-scanner/scripts/scan.py --full

# 浏览器隐私检查
python ~/.kimi/skills/privacy-scanner/scripts/scan.py --browser

# 临时文件清理
python ~/.kimi/skills/privacy-scanner/scripts/scan.py --clean

# 敏感数据深度扫描
python ~/.kimi/skills/privacy-scanner/scripts/scan.py --deep --include-memory
```

### 合规检查
```bash
# GDPR合规检查
python ~/.kimi/skills/privacy-scanner/scripts/compliance.py --standard gdpr

# CCPA合规检查
python ~/.kimi/skills/privacy-scanner/scripts/compliance.py --standard ccpa

# 中国个人信息保护法合规检查
python ~/.kimi/skills/privacy-scanner/scripts/compliance.py --standard pipl

# 生成合规报告
python ~/.kimi/skills/privacy-scanner/scripts/compliance.py --report --format pdf
```

### 清理与加固
```bash
# 自动清理发现的隐私风险
python ~/.kimi/skills/privacy-scanner/scripts/clean.py --auto

# 安全擦除特定文件 (DoD 5220.22-M标准)
python ~/.kimi/skills/privacy-scanner/scripts/secure-wipe.py --file sensitive.txt

# 配置隐私保护策略
python ~/.kimi/skills/privacy-scanner/scripts/config.py --set browser-clean-on-exit=true
```

---

## 扫描报告

### 报告示例

```json
{
  "scan_id": "priv-20260219-001",
  "timestamp": "2026-02-19T10:30:00Z",
  "scanner_version": "2.0.0",
  "summary": {
    "privacy_score": 72,
    "total_findings": 45,
    "critical": 2,
    "high": 8,
    "medium": 20,
    "low": 15
  },
  "findings": [
    {
      "id": "PRIV-001",
      "category": "browser",
      "severity": "critical",
      "title": "Chrome保存了未加密的信用卡信息",
      "location": "%LOCALAPPDATA%\\Google\\Chrome\\User Data\\Default\\Web Data",
      "description": "检测到明文存储的信用卡号，若恶意软件入侵可导致财务损失",
      "remediation": "立即删除保存的支付方式，启用主密码保护",
      "regulation": "PCI DSS 3.4"
    },
    {
      "id": "PRIV-002",
      "category": "system",
      "severity": "high",
      "title": "休眠文件包含内存敏感数据",
      "location": "C:\\hiberfil.sys",
      "description": "休眠文件可能包含密码、密钥等敏感内存数据",
      "remediation": "禁用休眠功能或启用休眠文件加密",
      "regulation": "GDPR Article 32"
    }
  ],
  "compliance_status": {
    "gdpr": "partial_compliant",
    "ccpa": "non_compliant",
    "pipa": "partial_compliant"
  },
  "recommendations": [
    "启用浏览器主密码保护",
    "配置系统休眠加密",
    "定期清理临时文件",
    "使用密码管理器替代浏览器保存密码"
  ]
}
```

---

## 深度安全分析

### 1. Threat Modeling (威胁建模)

Privacy Scanner Skill处理高度敏感的隐私数据，面临独特的威胁场景，需采用隐私威胁建模(Privacy Threat Modeling)方法：

**链接性威胁 (Linkability)**：攻击者可能关联多个扫描发现构建用户画像。例如，结合浏览器历史、近期文档和搜索记录可精确推断用户身份和兴趣。扫描报告本身成为隐私汇聚点，若泄露将一次性暴露所有隐私风险。建议实施数据最小化，扫描结果按需保留，扫描完成后立即清理临时数据。采用差分隐私技术，在报告中添加噪声防止个体识别。

**可识别性威胁 (Identifiability)**：扫描过程收集的数据可能直接或间接识别个人身份。内存转储分析可能提取用户凭证，剪贴板历史包含复制过的敏感信息。即使"匿名"数据，通过时空关联分析仍可重新识别。建议实施假名化处理，使用令牌替代真实标识符。建立数据分类标记，自动识别PII (个人身份信息)和特殊类别数据。支持k-匿名性验证，确保发布的数据集满足隐私保护标准。

**非期望信息泄露 (Non-repudiation)**：扫描报告记录了系统隐私状态，若被第三方获取可作为用户行为的证据。例如，特定软件使用记录可能与版权执法关联。建议实施报告访问审计，记录谁、何时、为何访问扫描结果。提供报告加密共享功能，使用临时解密密钥。支持报告过期自动销毁，避免长期存储带来的风险。

**信息泄露放大 (Detectability)**：扫描行为本身可被监控系统检测，攻击者通过观察扫描模式推断用户安全意识和系统弱点。例如，频繁扫描浏览器数据可能表明用户处理敏感信息。建议实施扫描混淆，将隐私扫描流量混入正常系统活动。支持离线扫描模式，在不联网环境下执行敏感检查。扫描日志本地加密存储，防止被其他应用读取。

**策略绕过威胁**：恶意软件可能检测隐私扫描器存在并暂时隐藏行为以逃避检测。攻击者可能篡改扫描规则排除特定检查项。建议实施扫描器完整性自验证，检测自身被篡改。使用行为分析而非单纯签名检测识别隐私风险。建立扫描基线，检测扫描结果的异常变化。

### 2. Defense in Depth (纵深防御)

隐私保护需要多层防御，确保单一防护失效不会导致隐私泄露：

**数据采集层防御**：扫描时实施内存保护，敏感数据仅在加密内存区域处理。使用安全字符串类型，防止敏感数据在内存中残留。扫描完成后立即覆盖内存缓冲区，避免数据残留在交换空间。对采集的数据实施实时分类，自动标记敏感度级别。

**数据传输层防御**：扫描报告传输使用端到端加密，TLS 1.3 with Certificate Pinning防止中间人攻击。实施传输完整性验证，使用HMAC-SHA256检测篡改。支持离线扫描模式，敏感扫描完全不经过网络。传输日志记录仅保存元数据，不包含扫描内容。

**数据存储层防御**：扫描报告使用AES-256-GCM加密，密钥派生使用Argon2id抗暴力破解。实施密钥托管策略，主密钥存储于TPM或安全密钥库。建立数据保留策略，自动清理超过保留期的扫描数据。支持报告分片存储，单点泄露无法重建完整信息。

**访问控制层防御**：基于属性的访问控制(ABAC)，根据用户角色、设备状态、网络位置动态授权。多因素认证保护扫描报告访问，敏感操作需生物识别确认。实施最小权限原则，扫描服务账户仅拥有必要的文件读取权限。会话超时机制，闲置15分钟自动锁定。

**审计与监控层防御**：详细记录扫描操作日志，包括谁发起扫描、扫描范围、访问的报告。实施异常检测，识别异常的扫描模式（如非工作时间大量数据导出）。建立数据泄露响应预案，发现报告泄露时自动触发通知和缓解措施。定期隐私影响评估(PIA)，审查扫描活动对隐私的影响。

### 3. Zero Trust (零信任)

零信任原则在隐私扫描场景中的特殊应用：

**永不信任采集的数据**：扫描采集的数据需经完整性验证，防止被恶意软件篡改误导。交叉验证扫描结果，多个独立来源确认同一发现。对异常扫描结果（如发现数量突然激增）进行人工复核。建立扫描结果的可信度评分，标识高置信度和待验证的发现。

**持续验证扫描环境**：扫描前验证执行环境安全性，检测是否存在键盘记录器、屏幕截图恶意软件。监控扫描过程中的系统行为，检测其他进程对扫描目标的访问。实施运行时应用自我保护(RASP)，防止扫描器被注入恶意代码。定期验证扫描规则库的完整性，确保检查项未被篡改。

**微分段与隔离**：隐私扫描在独立的安全域执行，与生产环境网络隔离。使用容器化或虚拟机隔离扫描进程，防止扫描器被攻破影响主机。扫描数据存储在隔离的加密卷，与常规数据存储物理分离。实施内存隔离，扫描进程内存空间与其他进程隔离。

**最小权限扫描**：按扫描类型分配最小必要权限，浏览器扫描无需系统文件访问权限。实施权限即时提升(JIT)，需要高权限时临时申请，完成后立即释放。支持非特权扫描模式，在标准用户权限下执行大部分检查。扫描完成后自动撤销所有临时权限。

**假设隐私已泄露设计**：设计假设扫描报告可能被泄露，最小化报告中包含的敏感信息。实施报告脱敏，自动替换真实用户名为假名。支持选择性报告生成，用户可排除特定类别的发现。建立泄露影响评估，量化报告泄露可能造成的隐私损害。

### 4. Risk Assessment (风险评估)

基于ISO 27005和NIST SP 800-30进行隐私专项风险评估：

**隐私风险场景识别**：
- 严重风险：扫描报告泄露导致身份盗用 (概率: 低，影响: 灾难性) - 风险等级: 高
- 严重风险：内存扫描提取到明文私钥 (概率: 中，影响: 严重) - 风险等级: 高
- 高风险：浏览器密码库被恶意软件读取 (概率: 中，影响: 高) - 风险等级: 高
- 中风险：临时文件包含敏感文档残留 (概率: 高，影响: 中) - 风险等级: 中
- 中风险：扫描行为被监控分析推断用户行为 (概率: 中，影响: 中) - 风险等级: 中
- 低风险：缩略图缓存泄露图片浏览历史 (概率: 高，影响: 低) - 风险等级: 低

**隐私影响评估(PIA)**：
- 数据主体影响：扫描可能暴露个人偏好、行为习惯、社交关系
- 数据控制者影响：企业用户可能违反员工隐私期望
- 合规影响：不当扫描可能违反GDPR "目的限制"和"数据最小化"原则
- 声誉影响：隐私扫描工具本身若存在漏洞将严重损害用户信任

**脆弱性评估**：
- 关键脆弱性：扫描器需要高权限访问敏感区域，存在权限滥用风险
- 高危脆弱性：扫描结果临时文件可能在清理前被其他应用读取
- 中危脆弱性：扫描规则更新机制可能被利用分发恶意规则
- 低危脆弱性：扫描进度显示可能泄露系统配置信息

**风险处置计划**：
| 风险项 | 处置策略 | 优先级 | 负责人 |
|--------|----------|--------|--------|
| 扫描报告泄露 | 加密存储+访问控制+自动清理 | P0 | 安全团队 |
| 内存凭证提取 | 安全内存处理+即时覆盖 | P0 | 开发团队 |
| 规则库篡改 | 代码签名+完整性验证 | P1 | 安全团队 |
| 扫描行为监控 | 混淆扫描模式+离线支持 | P2 | 架构团队 |

**持续风险监控指标**：
- 扫描报告访问异常次数
- 扫描数据导出量偏离基线
- 扫描器完整性校验失败次数
- 用户隐私投诉数量

### 5. Compliance Framework (合规框架)

Privacy Scanner必须满足全球主要隐私法规要求：

**GDPR (欧盟通用数据保护条例)**：
- Article 5 (原则)：扫描需遵循数据最小化、目的限制、存储限制原则
- Article 6 (合法性基础)：明确扫描的法律依据（合法利益或同意）
- Article 25 (隐私设计)：扫描器默认配置需保护隐私，非必要数据不收集
- Article 30 (记录)：维护扫描活动记录，包括扫描目的、数据类别、保留期限
- Article 32 (安全)：实施技术和组织措施保护扫描数据
- Article 35 (DPIA)：大规模扫描前进行数据保护影响评估

**CCPA/CPRA (加州消费者隐私法)**：
- 消费者知情权：扫描收集的数据需向用户披露
- 删除权：支持用户请求删除其扫描相关数据
- 退出权：允许用户退出某些类型的扫描
- 敏感个人信息：对扫描发现的敏感数据实施额外保护
- 服务提供商条款：若扫描数据共享给第三方，需符合服务提供商定义

**中国个人信息保护法 (PIPL)**：
- 告知同意：扫描前明确告知用户并获取同意
- 最小必要：仅扫描实现目的所必需的个人信息
- 敏感个人信息：对生物识别、宗教信仰等敏感数据增强保护
- 跨境传输：扫描数据出境需通过安全评估
- 个人权利：支持用户查询、更正、删除其扫描相关数据

**ePrivacy Regulation (电子隐私条例)**：
- 终端设备信息：扫描终端设备需用户同意
- Cookie规则：浏览器扫描需遵守Cookie同意要求
- 通信保密：不得扫描受保护的通信内容

**行业标准合规**：
- ISO 27701: 隐私信息管理体系扩展
- ISO 29100: 隐私框架标准
- NIST Privacy Framework: 隐私风险管理的NIST框架
- SOC 2 Type II: 服务组织控制报告隐私条款

**合规自动化功能**：
- 自动生成合规报告，映射发现到具体法规条款
- 合规差距分析，识别不符合项并提供整改建议
- 同意管理，记录用户扫描授权和撤回
- 数据主体请求(DSR)自动化，支持用户权利行使

---

## 参考实现

### 开源项目
- **OSQuery**: https://osquery.io/ - Facebook的SQL化系统监控
- **Wazuh**: https://wazuh.com/ - SIEM和XDR平台
- **Privacy Badger**: EFF的隐私保护工具
- **BleachBit**: 开源系统清理工具
- **CCleaner**: 商业隐私清理工具 (注意：曾被植入恶意代码)

### 隐私框架
- **GDPR**: https://gdpr.eu/
- **NIST Privacy Framework**: https://www.nist.gov/privacy-framework
- **ISO/IEC 29100**: 隐私框架标准

### 安全擦除标准
- **DoD 5220.22-M**: 美国国防部数据销毁标准
- **NIST SP 800-88**: 媒体消毒指南
- **Gutmann Method**: 35遍覆写方法

---

## 版本信息

- **Version**: 2.1.0 (隐私合规增强版)
- **Author**: KbotGenesis
- **Compliance**: GDPR, CCPA, PIPL, ePrivacy
- **License**: MIT
- **Last Privacy Review**: 2026-02-19
