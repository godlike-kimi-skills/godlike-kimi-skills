#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
MCP Builder - å¿«é€Ÿæ„å»ºMCP(Model Context Protocol)æœåŠ¡å™¨

ç”¨äºç”ŸæˆMCPæœåŠ¡å™¨è„šæ‰‹æ¶ã€ç®¡ç†å·¥å…·å’ŒéªŒè¯é…ç½®ã€‚
"""

import argparse
import json
import os
import sys
from pathlib import Path
from typing import Dict, List, Optional, Any


# =============================================================================
# æ¨¡æ¿å®šä¹‰
# =============================================================================

WEATHER_TOOL_TEMPLATE = '''
@mcp.tool()
async def get_current_weather(location: str, unit: str = "celsius") -> str:
    """
    è·å–æŒ‡å®šä½ç½®çš„å½“å‰å¤©æ°”ã€‚
    
    Args:
        location: åŸå¸‚åç§°æˆ–ä½ç½®
        unit: æ¸©åº¦å•ä½ (celsius/fahrenheit)
    
    Returns:
        å¤©æ°”ä¿¡æ¯å­—ç¬¦ä¸²
    """
    # è¿™é‡Œé›†æˆå®é™…çš„å¤©æ°”API
    return f"å½“å‰ {location} çš„å¤©æ°”: æ™´æœ—, 25Â°{unit[0].upper()}"


@mcp.tool()
async def get_forecast(location: str, days: int = 3) -> str:
    """
    è·å–å¤©æ°”é¢„æŠ¥ã€‚
    
    Args:
        location: åŸå¸‚åç§°æˆ–ä½ç½®
        days: é¢„æŠ¥å¤©æ•° (1-7)
    
    Returns:
        å¤©æ°”é¢„æŠ¥å­—ç¬¦ä¸²
    """
    return f"{location} æœªæ¥ {days} å¤©é¢„æŠ¥: æ™´è½¬å¤šäº‘"
'''

SEARCH_TOOL_TEMPLATE = '''
@mcp.tool()
async def web_search(query: str, limit: int = 10) -> str:
    """
    æ‰§è¡Œç½‘é¡µæœç´¢ã€‚
    
    Args:
        query: æœç´¢å…³é”®è¯
        limit: è¿”å›ç»“æœæ•°é‡
    
    Returns:
        æœç´¢ç»“æœåˆ—è¡¨
    """
    # é›†æˆæœç´¢å¼•æ“API
    return f"æœç´¢ '{query}' çš„ç»“æœ (å‰{limit}æ¡): [ç¤ºä¾‹ç»“æœ]"


@mcp.tool()
async def local_search(path: str, pattern: str) -> str:
    """
    åœ¨æœ¬åœ°æ–‡ä»¶ä¸­æœç´¢ã€‚
    
    Args:
        path: æœç´¢ç›®å½•è·¯å¾„
        pattern: æ–‡ä»¶åŒ¹é…æ¨¡å¼
    
    Returns:
        åŒ¹é…çš„æ–‡ä»¶åˆ—è¡¨
    """
    import glob
    files = glob.glob(os.path.join(path, "**", pattern), recursive=True)
    return f"æ‰¾åˆ° {len(files)} ä¸ªåŒ¹é…æ–‡ä»¶"
'''

CALCULATOR_TOOL_TEMPLATE = '''
@mcp.tool()
async def calculate(expression: str) -> str:
    """
    è®¡ç®—æ•°å­¦è¡¨è¾¾å¼ã€‚
    
    Args:
        expression: æ•°å­¦è¡¨è¾¾å¼ï¼Œå¦‚ "2 + 2" æˆ– "sin(pi/2)"
    
    Returns:
        è®¡ç®—ç»“æœ
    """
    try:
        # å®‰å…¨è®¡ç®— - ä½¿ç”¨evalçš„é™åˆ¶ç‰ˆæœ¬
        allowed = {"__builtins__": {}}
        allowed.update({
            "abs": abs, "round": round, "max": max, "min": min,
            "sum": sum, "pow": pow
        })
        result = eval(expression, allowed, {"pi": 3.14159, "e": 2.71828})
        return str(result)
    except Exception as e:
        return f"è®¡ç®—é”™è¯¯: {str(e)}"


@mcp.tool()
async def convert_unit(value: float, from_unit: str, to_unit: str) -> str:
    """
    å•ä½è½¬æ¢ã€‚
    
    Args:
        value: è¦è½¬æ¢çš„æ•°å€¼
        from_unit: æºå•ä½
        to_unit: ç›®æ ‡å•ä½
    
    Returns:
        è½¬æ¢åçš„å€¼
    """
    conversions = {
        ("m", "km"): 0.001,
        ("km", "m"): 1000,
        ("c", "f"): lambda x: x * 9/5 + 32,
        ("f", "c"): lambda x: (x - 32) * 5/9,
    }
    key = (from_unit.lower(), to_unit.lower())
    if key in conversions:
        conv = conversions[key]
        result = conv(value) if callable(conv) else value * conv
        return f"{value} {from_unit} = {result} {to_unit}"
    return f"ä¸æ”¯æŒçš„å•ä½è½¬æ¢: {from_unit} -> {to_unit}"
'''

FILE_TOOL_TEMPLATE = '''
@mcp.tool()
async def read_file(path: str, encoding: str = "utf-8") -> str:
    """
    è¯»å–æ–‡ä»¶å†…å®¹ã€‚
    
    Args:
        path: æ–‡ä»¶è·¯å¾„
        encoding: æ–‡ä»¶ç¼–ç 
    
    Returns:
        æ–‡ä»¶å†…å®¹
    """
    try:
        with open(path, "r", encoding=encoding) as f:
            return f.read()
    except Exception as e:
        return f"è¯»å–é”™è¯¯: {str(e)}"


@mcp.tool()
async def write_file(path: str, content: str, encoding: str = "utf-8") -> str:
    """
    å†™å…¥æ–‡ä»¶å†…å®¹ã€‚
    
    Args:
        path: æ–‡ä»¶è·¯å¾„
        content: æ–‡ä»¶å†…å®¹
        encoding: æ–‡ä»¶ç¼–ç 
    
    Returns:
        æ“ä½œç»“æœ
    """
    try:
        with open(path, "w", encoding=encoding) as f:
            f.write(content)
        return f"æ–‡ä»¶å·²å†™å…¥: {path}"
    except Exception as e:
        return f"å†™å…¥é”™è¯¯: {str(e)}"


@mcp.tool()
async def list_directory(path: str = ".") -> str:
    """
    åˆ—å‡ºç›®å½•å†…å®¹ã€‚
    
    Args:
        path: ç›®å½•è·¯å¾„
    
    Returns:
        ç›®å½•å†…å®¹åˆ—è¡¨
    """
    try:
        items = os.listdir(path)
        return "\\n".join(items) if items else "ç›®å½•ä¸ºç©º"
    except Exception as e:
        return f"åˆ—å‡ºç›®å½•é”™è¯¯: {str(e)}"
'''


# =============================================================================
# MCPæœåŠ¡å™¨ä»£ç æ¨¡æ¿
# =============================================================================

SERVER_TEMPLATE_STDIO = '''#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
{server_name} - MCP Server
Generated by MCP Builder
"""

import os
import sys
from mcp.server.fastmcp import FastMCP

# åˆå§‹åŒ–MCPæœåŠ¡å™¨
mcp = FastMCP("{server_name}")


# =============================================================================
# å·¥å…·å®šä¹‰
# =============================================================================

{tools_code}


# =============================================================================
# ä¸»å…¥å£
# =============================================================================

if __name__ == "__main__":
    # stdioæ¨¡å¼è¿è¡Œ
    mcp.run(transport="stdio")
'''

SERVER_TEMPLATE_SSE = '''#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
{server_name} - MCP Server (SSE Mode)
Generated by MCP Builder
"""

import os
import sys
import argparse
from mcp.server.fastmcp import FastMCP
from mcp.server.sse import SseServerTransport
from starlette.applications import Starlette
from starlette.routing import Mount, Route
import uvicorn

# åˆå§‹åŒ–MCPæœåŠ¡å™¨
mcp = FastMCP("{server_name}")


# =============================================================================
# å·¥å…·å®šä¹‰
# =============================================================================

{tools_code}


# =============================================================================
# SSE æœåŠ¡å™¨è®¾ç½®
# =============================================================================

def create_app():
    """åˆ›å»ºStarletteåº”ç”¨"""
    sse = SseServerTransport("/messages/")
    
    async def handle_sse(request):
        async with sse.connect_sse(
            request.scope, request.receive, request.send
        ) as (read_stream, write_stream):
            await mcp.run(
                read_stream, write_stream, mcp.create_initialization_options()
            )
    
    return Starlette(
        debug=True,
        routes=[
            Route("/sse", endpoint=handle_sse),
            Mount("/messages/", app=sse.handle_post_message),
        ],
    )


# =============================================================================
# ä¸»å…¥å£
# =============================================================================

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="{server_name} MCP Server")
    parser.add_argument("--port", type=int, default={port}, help="æœåŠ¡å™¨ç«¯å£")
    parser.add_argument("--host", type=str, default="0.0.0.0", help="æœåŠ¡å™¨ä¸»æœº")
    args = parser.parse_args()
    
    app = create_app()
    print(f"Starting {server_name} on http://{args.host}:{args.port}")
    uvicorn.run(app, host=args.host, port=args.port)
'''

CONFIG_TEMPLATE = '''{{
  "name": "{server_name}",
  "version": "1.0.0",
  "description": "MCP Server generated by MCP Builder",
  "transport": "{transport}",
  "port": {port},
  "tools": [{tools_list}]
}}
'''

REQUIREMENTS_TEMPLATE = '''mcp>=1.0.0
{extra_deps}
'''

README_TEMPLATE = '''# {server_name}

ç”± MCP Builder ç”Ÿæˆçš„ MCP æœåŠ¡å™¨ã€‚

## è¿è¡Œ

```bash
# stdioæ¨¡å¼
python server.py

# sseæ¨¡å¼
python server.py --port 8080
```

## å·¥å…·åˆ—è¡¨

{tools_docs}
'''


# =============================================================================
# MCPBuilder ä¸»ç±»
# =============================================================================

class MCPBuilder:
    """MCPæœåŠ¡å™¨æ„å»ºå™¨"""
    
    TEMPLATES = {
        "weather": WEATHER_TOOL_TEMPLATE,
        "search": SEARCH_TOOL_TEMPLATE,
        "calculator": CALCULATOR_TOOL_TEMPLATE,
        "file": FILE_TOOL_TEMPLATE,
    }
    
    def __init__(self, output_dir: str = "./mcp-server"):
        self.output_dir = Path(output_dir)
        self.tools_dir = self.output_dir / "tools"
    
    def init_server(
        self,
        name: str,
        transport: str = "stdio",
        port: int = 3000,
        templates: Optional[List[str]] = None,
        force: bool = False
    ) -> Dict[str, Any]:
        """
        åˆå§‹åŒ–MCPæœåŠ¡å™¨é¡¹ç›®ã€‚
        
        Args:
            name: æœåŠ¡å™¨åç§°
            transport: ä¼ è¾“æ–¹å¼ (stdio/sse)
            port: SSEæ¨¡å¼ç«¯å£
            templates: é¢„è®¾æ¨¡æ¿åˆ—è¡¨
            force: æ˜¯å¦å¼ºåˆ¶è¦†ç›–
        
        Returns:
            æ“ä½œç»“æœä¿¡æ¯
        """
        if self.output_dir.exists() and not force:
            return {
                "success": False,
                "error": f"ç›®å½•å·²å­˜åœ¨: {self.output_dir}ï¼Œä½¿ç”¨ --force å¼ºåˆ¶è¦†ç›–"
            }
        
        # åˆ›å»ºç›®å½•ç»“æ„
        self.output_dir.mkdir(parents=True, exist_ok=True)
        self.tools_dir.mkdir(exist_ok=True)
        
        # æ”¶é›†å·¥å…·ä»£ç 
        tools_code = []
        tools_list = []
        templates = templates or []
        
        for template_name in templates:
            if template_name in self.TEMPLATES:
                tools_code.append(self.TEMPLATES[template_name])
                tools_list.append(f'"{template_name}"')
        
        # å¦‚æœæ²¡æœ‰æ¨¡æ¿ï¼Œæ·»åŠ ç¤ºä¾‹å·¥å…·
        if not tools_code:
            tools_code.append('''
@mcp.tool()
async def hello(name: str = "World") -> str:
    """
    ç¤ºä¾‹å·¥å…·: æ‰“æ‹›å‘¼
    
    Args:
        name: åç§°
    
    Returns:
        é—®å€™è¯­
    """
    return f"Hello, {name}!"
''')
            tools_list.append('"hello"')
        
        tools_code_str = "\n".join(tools_code)
        tools_list_str = ", ".join(tools_list)
        
        # ç”ŸæˆæœåŠ¡å™¨æ–‡ä»¶
        if transport == "sse":
            server_code = SERVER_TEMPLATE_SSE.format(
                server_name=name,
                tools_code=tools_code_str,
                port=port
            )
            extra_deps = "fastapi>=0.100.0\nuvicorn>=0.23.0\nstarlette>=0.30.0"
        else:
            server_code = SERVER_TEMPLATE_STDIO.format(
                server_name=name,
                tools_code=tools_code_str
            )
            extra_deps = ""
        
        # å†™å…¥æ–‡ä»¶
        (self.output_dir / "server.py").write_text(server_code, encoding="utf-8")
        
        config_content = CONFIG_TEMPLATE.format(
            server_name=name,
            transport=transport,
            port=port,
            tools_list=tools_list_str
        )
        (self.output_dir / "config.json").write_text(config_content, encoding="utf-8")
        
        requirements_content = REQUIREMENTS_TEMPLATE.format(extra_deps=extra_deps)
        (self.output_dir / "requirements.txt").write_text(
            requirements_content, encoding="utf-8"
        )
        
        # åˆ›å»º __init__.py
        (self.tools_dir / "__init__.py").write_text("", encoding="utf-8")
        
        # åˆ›å»ºREADME
        tools_docs = "\n".join([f"- {t}" for t in templates]) if templates else "- hello"
        readme_content = README_TEMPLATE.format(
            server_name=name,
            tools_docs=tools_docs
        )
        (self.output_dir / "README.md").write_text(readme_content, encoding="utf-8")
        
        return {
            "success": True,
            "message": f"MCPæœåŠ¡å™¨ '{name}' åˆ›å»ºæˆåŠŸ",
            "output_dir": str(self.output_dir),
            "transport": transport,
            "templates": templates or ["hello"]
        }
    
    def validate(self) -> Dict[str, Any]:
        """
        éªŒè¯MCPæœåŠ¡å™¨é…ç½®ã€‚
        
        Returns:
            éªŒè¯ç»“æœ
        """
        issues = []
        
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶
        required_files = ["server.py", "config.json"]
        for file in required_files:
            file_path = self.output_dir / file
            if not file_path.exists():
                issues.append(f"ç¼ºå°‘å¿…è¦æ–‡ä»¶: {file}")
        
        # éªŒè¯é…ç½®æ–‡ä»¶
        config_path = self.output_dir / "config.json"
        if config_path.exists():
            try:
                with open(config_path, "r", encoding="utf-8") as f:
                    config = json.load(f)
                
                required_keys = ["name", "transport"]
                for key in required_keys:
                    if key not in config:
                        issues.append(f"é…ç½®æ–‡ä»¶ç¼ºå°‘å¿…è¦å­—æ®µ: {key}")
                
                if config.get("transport") == "sse" and "port" not in config:
                    issues.append("SSEæ¨¡å¼éœ€è¦æŒ‡å®športå­—æ®µ")
                    
            except json.JSONDecodeError as e:
                issues.append(f"é…ç½®æ–‡ä»¶JSONæ ¼å¼é”™è¯¯: {e}")
        
        return {
            "valid": len(issues) == 0,
            "issues": issues,
            "message": "éªŒè¯é€šè¿‡" if not issues else f"å‘ç° {len(issues)} ä¸ªé—®é¢˜"
        }
    
    def add_tool(self, name: str, description: str) -> Dict[str, Any]:
        """
        æ·»åŠ æ–°å·¥å…·åˆ°ç°æœ‰æœåŠ¡å™¨ã€‚
        
        Args:
            name: å·¥å…·åç§°
            description: å·¥å…·æè¿°
        
        Returns:
            æ“ä½œç»“æœ
        """
        tool_file = self.tools_dir / f"{name}.py"
        
        tool_template = f'''from mcp.server.fastmcp import FastMCP

mcp = FastMCP("{name}")


@mcp.tool()
async def {name}(param: str) -> str:
    """
    {description}
    
    Args:
        param: è¾“å…¥å‚æ•°
    
    Returns:
        å¤„ç†ç»“æœ
    """
    # TODO: å®ç°å·¥å…·é€»è¾‘
    return f"{{name}} ç»“æœ: {{param}}"
'''
        
        tool_file.write_text(tool_template, encoding="utf-8")
        
        return {
            "success": True,
            "message": f"å·¥å…· '{name}' å·²æ·»åŠ åˆ° {tool_file}"
        }


# =============================================================================
# å‘½ä»¤è¡Œæ¥å£
# =============================================================================

def main():
    """å‘½ä»¤è¡Œå…¥å£"""
    parser = argparse.ArgumentParser(
        description="MCP Builder - å¿«é€Ÿæ„å»ºMCPæœåŠ¡å™¨",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  %(prog)s init --name my-server --output ./my-mcp
  %(prog)s init --name api-server --transport sse --port 8080
  %(prog)s init --templates weather search
  %(prog)s validate --output ./my-mcp
        """
    )
    
    parser.add_argument(
        "action",
        choices=["init", "add-tool", "validate", "build"],
        help="æ“ä½œç±»å‹"
    )
    
    parser.add_argument(
        "--name", "-n",
        default="mcp-server",
        help="æœåŠ¡å™¨åç§° (é»˜è®¤: mcp-server)"
    )
    
    parser.add_argument(
        "--output", "-o",
        default="./mcp-server",
        help="è¾“å‡ºç›®å½• (é»˜è®¤: ./mcp-server)"
    )
    
    parser.add_argument(
        "--transport", "-t",
        choices=["stdio", "sse"],
        default="stdio",
        help="ä¼ è¾“æ–¹å¼ (é»˜è®¤: stdio)"
    )
    
    parser.add_argument(
        "--port", "-p",
        type=int,
        default=3000,
        help="SSEæ¨¡å¼ç«¯å£ (é»˜è®¤: 3000)"
    )
    
    parser.add_argument(
        "--templates",
        nargs="+",
        choices=["weather", "search", "calculator", "file"],
        help="é¢„è®¾æ¨¡æ¿"
    )
    
    parser.add_argument(
        "--force", "-f",
        action="store_true",
        help="å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶"
    )
    
    parser.add_argument(
        "--description", "-d",
        default="",
        help="å·¥å…·æè¿° (ç”¨äºadd-tool)"
    )
    
    args = parser.parse_args()
    
    # æ‰§è¡Œæ“ä½œ
    builder = MCPBuilder(args.output)
    
    if args.action == "init":
        result = builder.init_server(
            name=args.name,
            transport=args.transport,
            port=args.port,
            templates=args.templates,
            force=args.force
        )
        
        if result["success"]:
            print(f"âœ… {result['message']}")
            print(f"ğŸ“ è¾“å‡ºç›®å½•: {result['output_dir']}")
            print(f"ğŸ”Œ ä¼ è¾“æ–¹å¼: {result['transport']}")
            print(f"ğŸ› ï¸  å·¥å…·: {', '.join(result['templates'])}")
            print("\nä¸‹ä¸€æ­¥:")
            print(f"  cd {args.output}")
            print("  pip install -r requirements.txt")
            print("  python server.py")
        else:
            print(f"âŒ é”™è¯¯: {result['error']}")
            sys.exit(1)
    
    elif args.action == "add-tool":
        if not args.name or args.name == "mcp-server":
            print("âŒ é”™è¯¯: è¯·ä½¿ç”¨ --name æŒ‡å®šå·¥å…·åç§°")
            sys.exit(1)
        
        result = builder.add_tool(args.name, args.description or args.name)
        print(f"âœ… {result['message']}")
    
    elif args.action in ("validate", "build"):
        result = builder.validate()
        
        if result["valid"]:
            print(f"âœ… {result['message']}")
        else:
            print(f"âš ï¸  {result['message']}")
            for issue in result["issues"]:
                print(f"   - {issue}")
            sys.exit(1)


if __name__ == "__main__":
    main()
